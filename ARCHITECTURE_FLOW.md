# GearGenie - High-Level Architecture Flow

## System Overview
GearGenie is a vehicle health monitoring and maintenance booking system with three main layers: Mobile App, Backend Services, and ML Engine for predictive analytics.

---

## Architecture Components

### 1. **CLIENT LAYER - React Native Mobile App** (`carHealthApp/`)
**Technology**: React Native + Expo, Firebase Auth, AsyncStorage  
**Port**: Runs on device/emulator

#### Key Screens:
- **LoginScreen** → Firebase Authentication
- **DoorstepPickupScreen** → Shows vehicle health status (from ML predictions)
- **BookingChoiceScreen** → User selects service type (Doorstep Pickup or OEM Garage Visit)
- **BookingPickupScreen** → Collects customer details + location for doorstep service
- **BookingVisitScreen** → For garage/service center visits
- **OEMGaragesScreen** → Displays nearby service centers (map-based)
- **HealthCard Component** → Displays RUL (Remaining Useful Life) and vehicle health status

#### Data Flow:
1. User logs in via Firebase
2. App loads vehicle health from **ML Backend** via OBD data
3. User selects booking type
4. Booking details submitted to **Booking API** (Node.js)

---

### 2. **ML PREDICTION ENGINE** (`backend/main.py`)
**Technology**: FastAPI (Python), Scikit-learn, joblib  
**Port**: 8000 (Uvicorn)  
**Models Loaded**: Classifiers + RUL Regressors for Engine, Brake, Battery

#### Data Flow:

**Endpoint: POST `/predict`**
- Receives OBD sensor data from mobile app
- Runs predictions through 3 subsystems:
  - Engine health (Healthy/Attention/Critical)
  - Brake health (Healthy/Attention/Critical)
  - Battery health (Healthy/Attention/Critical)
- Returns RUL (Remaining Useful Life) in km for each subsystem
- Calculates estimated repair costs from CSV dataset
- **Pushes predictions to MongoDB** (service estimates collection)

**Endpoint: POST `/service-estimate`**
- Generates detailed PDF report with:
  - Health status breakdown
  - RUL predictions
  - Repair cost estimates
- Returns streaming PDF response

**Endpoint: GET `/health`**
- Health check endpoint

---

### 3. **BOOKING API** (`backend/booking-api/server.js`)
**Technology**: Node.js + Express, MongoDB + Mongoose, CORS  
**Port**: 5000  
**Database**: MongoDB (connection via `.env` MONGO_URI)

#### Models:
- **Booking** - Stores customer booking requests (name, phone, address, date, time, service type)
- **ServiceEstimate** - Stores ML prediction results linked to vehicleId

#### Endpoints:

**POST `/book`**
- Receives booking data from mobile app
- Stores in MongoDB Booking collection
- Used for both doorstep pickup and garage visit bookings

**GET `/bookings`**
- Fetches all bookings (sorted by most recent)
- Used by dealer/admin dashboard

**POST `/api/service-estimates`**
- Stores service estimates generated by ML engine

**GET `/api/service-estimates/:vehicleId`**
- Retrieves historical estimates for a specific vehicle

---

## Data Flow Scenarios

### Scenario 1: Vehicle Health Check (User opens app)
```
Mobile App (carHealthApp)
    ↓ (Sends OBD data)
    ↓
ML Engine (main.py:8000)
    ├─ Loads classifier models (engine, brake, battery)
    ├─ Loads RUL regressors
    ├─ Processes OBD sensor inputs
    ├─ Returns health status + RUL predictions
    └─ Pushes estimates to MongoDB
    ↓ (Returns predictions)
Mobile App (Displays HealthCard)
```

### Scenario 2: Customer Booking Service
```
Mobile App (BookingPickupScreen)
    ↓ (Collects: name, phone, address, date, time)
    ↓
Booking API (server.js:5000)
    ├─ Validates request
    └─ Stores in MongoDB Booking collection
    ↓ (Success confirmation)
Mobile App (Shows confirmation message)
```

### Scenario 3: Service Report Generation
```
Mobile App (After health check)
    ↓ (Requests service estimate PDF)
    ↓
ML Engine (main.py:8000 - /service-estimate)
    ├─ Generates detailed PDF report
    ├─ Includes health breakdown, RUL, costs
    └─ Returns streaming PDF
    ↓ (Returns PDF stream)
Mobile App (Displays/Downloads PDF)
```

---

## External Integrations

### Firebase
- User authentication (login/signup)
- Stores user profile data
- Used by: Mobile App

### MongoDB
- Stores bookings from app users
- Stores service estimates from ML predictions
- Used by: Booking API (reads/writes)

### Pre-trained ML Models (Stored Locally)
- `classifier_engine_model.pkl` - Engine health classifier
- `classifier_brake_model.pkl` - Brake health classifier
- `classifier_battery_model.pkl` - Battery health classifier
- `rul_engine_regressor.pkl` - Engine RUL predictor
- `rul_brake_regressor.pkl` - Brake RUL predictor
- `rul_battery_regressor.pkl` - Battery RUL predictor
- `failure_repair_costs.csv` - Cost lookup table

---

## Communication Protocols

| From | To | Port | Protocol | Purpose |
|------|-----|------|----------|---------|
| Mobile App | ML Engine | 8000 | HTTP REST | OBD prediction & service estimates |
| Mobile App | Booking API | 5000 | HTTP REST | Submit booking requests |
| Booking API | MongoDB | - | Mongoose ODM | Store/retrieve bookings |
| ML Engine | MongoDB | - | HTTP Requests | Push service estimates |
| Mobile App | Firebase | - | Firebase SDK | User authentication |

---

## Architecture Diagram Prompt

Use this prompt to create a visual architecture diagram:

> Create an architecture diagram showing:
> 
> **Top Layer**: React Native Mobile App (carHealthApp) with screens:
> - LoginScreen (Firebase Auth)
> - DoorstepPickupScreen (Health Display)
> - BookingChoiceScreen (Service Type Selection)
> - BookingPickupScreen (Booking Details)
> 
> **Middle Layer**: Two backend services:
> - **ML Engine** (FastAPI on port 8000)
>   - Receives OBD data
>   - Runs 3 classifiers (engine/brake/battery health)
>   - Runs 3 RUL regressors
>   - Returns predictions & estimates
> - **Booking API** (Node.js Express on port 5000)
>   - POST /book endpoint (stores bookings)
>   - GET /bookings (retrieves bookings)
>   - Service Estimate endpoints
> 
> **Bottom Layer**: Data stores:
> - MongoDB (Bookings & ServiceEstimates collections)
> - Pre-trained ML models (6 joblib files)
> - Firebase (User Auth)
> 
> **Data Flow Arrows**:
> - App → ML Engine (OBD data) ← Predictions back
> - App → Booking API (booking data) ← Confirmation back
> - Booking API ↔ MongoDB (read/write)
> - ML Engine → MongoDB (push estimates)
> - App ↔ Firebase (authentication)

---

## Key Technology Stack

| Layer | Technology | Purpose |
|-------|-----------|---------|
| Frontend | React Native + Expo | Mobile app UI |
| ML/AI | FastAPI + Scikit-learn | Vehicle health prediction |
| Backend API | Node.js + Express | Booking management |
| Database | MongoDB + Mongoose | Data persistence |
| Auth | Firebase | User authentication |
| OBD Integration | Via mobile app | Vehicle sensor data input |

---

## Environment Variables Required

**Booking API (`.env`)**:
- `MONGO_URI` - MongoDB connection string

**ML Engine**:
- Requires saved models in `../../saved_models/` directory
- Requires `../../failure_repair_costs.csv`

---

## Future Scalability Considerations
- API Gateway layer to route between services
- Message queue (RabbitMQ/Kafka) for async booking notifications
- Dealership Admin Dashboard (separate React frontend)
- Real-time WebSocket for live booking updates
- Caching layer (Redis) for frequently accessed predictions
